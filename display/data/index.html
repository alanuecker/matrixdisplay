<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Matrix Display</title>

    <style>
      .grid-element {
        width: 1rem;
        height: 1rem;
        margin: 0.125rem;
      }
    </style>
  </head>

  <body>
    <div id="grid"></div>
    <script>
      window.onload = () => {
        const grid = document.createElement("div");
        for (let i = 0; i < 32; i += 1) {
          for (let j = 0; j < 64; j += 1) {
            const element = document.createElement("input");
            element.className = "grid-element";
            element.type = "color";
            element.onchange = e => {
              const data = { x: j, y: i };
              const color = e.target.value
                .match(/[A-Za-z0-9]{2}/g)
                .map(v => parseInt(v, 16));
              data.r = color[0];
              data.g = color[1];
              data.b = color[2];
              if (connection.readyState === WebSocket.OPEN)
                connection.send(JSON.stringify(data));
            };
            grid.appendChild(element);
          }
          grid.appendChild(document.createElement("br"));
        }
        document.getElementById("grid").appendChild(grid);
      };

      var connection = new WebSocket("ws://" + location.hostname + ":81/", [
        "arduino"
      ]);
      connection.onopen = function() {
        connection.send("Connect " + new Date());
      };
      connection.onerror = function(error) {
        console.log("WebSocket Error ", error);
      };
      connection.onmessage = function(e) {
        console.log("Server: ", e.data);
      };
      connection.onclose = function() {
        console.log("WebSocket connection closed");
      };

      function sendRGB() {
        var r = document.getElementById("r").value ** 2 / 1023;
        var g = document.getElementById("g").value ** 2 / 1023;
        var b = document.getElementById("b").value ** 2 / 1023;

        var rgb = (r << 20) | (g << 10) | b;
        var rgbstr = "#" + rgb.toString(16);
        console.log("RGB: " + rgbstr);
        connection.send(rgbstr);
      }
    </script>
  </body>
</html>
